<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Operator's Playbook (Protected)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; min-height:100vh; display:grid; place-items:center; background:#0b0f14; color:#e5e7eb; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .card { width:min(520px,92vw); background:#121826; border:1px solid #263041; border-radius:14px; padding:24px; box-shadow:0 12px 42px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    p { margin:0 0 16px; color:#9aa4b2; }
    input { width:100%; box-sizing:border-box; border-radius:10px; border:1px solid #2f3a4e; background:#0f172a; color:#e5e7eb; padding:12px; font-size:1rem; }
    button { margin-top:12px; width:100%; border:0; border-radius:10px; padding:12px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .msg { margin-top:10px; min-height:1.25em; color:#fca5a5; font-size:.95rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Operator's Playbook</h1>
    <p>Protected view. Enter the shared passphrase.</p>
    <input id="pw" type="password" autocomplete="current-password" placeholder="Passphrase" />
    <button id="go">Unlock</button>
    <div id="msg" class="msg"></div>
  </div>
  <script>
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();
    const msg = document.getElementById('msg');
    const pw = document.getElementById('pw');
    const go = document.getElementById('go');

    const b64ToU8 = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));

    async function unlock() {
      msg.textContent = '';
      go.disabled = true;
      go.textContent = 'Decrypting...';
      try {
        const r = await fetch('./operator_playbook.enc.json', { cache: 'no-store' });
        if (!r.ok) throw new Error('Cannot load encrypted payload');
        const payload = await r.json();
        const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(pw.value), 'PBKDF2', false, ['deriveKey']);
        const key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: b64ToU8(payload.salt), iterations: payload.iterations, hash: 'SHA-256' },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['decrypt']
        );
        const plainBuf = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: b64ToU8(payload.iv) },
          key,
          b64ToU8(payload.ciphertext)
        );
        const html = decoder.decode(plainBuf);
        document.open();
        document.write(html);
        document.close();
      } catch (_) {
        msg.textContent = 'Invalid passphrase or payload.';
      } finally {
        go.disabled = false;
        go.textContent = 'Unlock';
      }
    }

    go.addEventListener('click', unlock);
    pw.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlock(); });
  </script>
</body>
</html>